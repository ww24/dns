box: python:2.7

build:
  steps:
    - install-packages:
      packages: gettext

    - script:
      name: set working directory
      code: |
        export WERCKER_SOURCE_DIR="${WERCKER_SOURCE_DIR}/terraform"
        echo "WERCKER_SOURCE_DIR=${WERCKER_SOURCE_DIR}"

    - script:
      name: generate account.json
      code: |
        cat <<EOF > account.json
        {
          "private_key": "${GCP_PRIVATE_KEY}",
          "client_email": "${GCP_CLIENT_EMAIL}"
        }
        EOF

    - script:
      name: generate backend.tf
      code: |
        export ACCOUNT_JSON=$(cat account.json | sed -e 's/"/\\"/g')
        envsubst < backend.tf.template > backend.tf
        cat backend.tf

    - script:
      name: generate variables.tfvars
      code: |
        envsubst < variables.tfvars.template > variables.tfvars
        cat variables.tfvars

    - ww24/terraform@0.11.3-rc.2:
      command: plan
      var_file: variables.tfvars

deploy:
  steps:
    - script:
      name: install gsutil
      code: |
        pip install gsutil

    - script:
      name: set working directory
      code: |
        export WERCKER_SOURCE_DIR="${WERCKER_SOURCE_DIR}/terraform"
        echo "WERCKER_SOURCE_DIR=${WERCKER_SOURCE_DIR}"

    - ww24/terraform@0.11.3-rc.2:
      command: plan
      var_file: variables.tfvars
